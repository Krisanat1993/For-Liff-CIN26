<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Check-In</title>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: #f4f4f9;
            color: #333;
        }
        .hidden {
            display: none;
        }
        #loading-message {
            margin-top: 40px;
            font-size: 1.2em;
        }
        header {
            margin-bottom: 20px;
        }
        header img {
            width: 80px;
        }
        section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
        }
        input,
        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #00B900;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #009900;
        }
        .message {
            text-align: center;
            margin-top: 15px;
            font-size: 1em;
            color: #555;
            line-height: 1.5;
        }
        #qr-reader {
            margin-top: 20px;
            border: 1px dashed #ccc;
            border-radius: 8px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 25px;
            border-radius: 12px;
            text-align: left;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .modal-content h2 {
            text-align: center;
            margin-top: 0;
        }
        .modal-content p {
            margin: 10px 0;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-evenly;
            margin-top: 25px;
            gap: 15px;
        }
        .modal-buttons button {
            width: 100%;
            margin: 0;
        }
        #cancelPhoneButton, #cancelScanButton, #retryScanButton {
            background-color: #f44336;
        }
        #cancelPhoneButton:hover, #cancelScanButton:hover, #retryScanButton:hover {
            background-color: #d32f2f;
        }
        #confirmPhoneButton, #confirmScanButton {
             background-color: #00B900;
        }
        #retryLocationButton {
             background-color: #007bff;
        }
        #retryLocationButton:hover {
             background-color: #0056b3;
        }
        #showInstructionsButton {
            background-color: #ff9800;
        }
        #showInstructionsButton:hover {
            background-color: #f57c00;
        }

        /* --- [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ --- */
        #locationInstructions {
            text-align: center;
        }
        #locationInstructions h3 {
            margin-bottom: 15px;
        }
        #locationInstructions p {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            line-height: 1.7;
        }
        #backToPermissionModal {
            margin-top: 20px;
            background-color: #6c757d;
        }
        #backToPermissionModal:hover {
            background-color: #5a6268;
        }
        /* --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà --- */

        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            height: 25px;
        }
        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: #00B900;
            transition: width 0.5s ease-in-out;
        }
        .comparison-container {
            margin-top: 20px;
            text-align: left;
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 8px;
            padding: 15px;
        }
        .comparison-container h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #d32f2f;
            text-align: center;
            font-size: 1.2em;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 12px;
            align-items: center;
        }
        .comparison-grid strong {
            font-weight: bold;
        }
        .comparison-grid .mismatch {
            color: #d32f2f;
            font-weight: bold;
            background-color: #ffebee;
            padding: 2px 6px;
            border-radius: 4px;
        }
         .comparison-grid .match {
            color: #00B900;
        }
    </style>
</head>
<body>
    <div id="loading-message">
        <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
    </div>

    <header id="header" class="hidden">
        <img src="https://drive.google.com/thumbnail?id=1biw0LeK_X0ntKPdH4-8XaPUcl1yGDl59" alt="Logo" />
    </header>

    <section id="form-section" class="hidden">
        <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
        <p>‡∏ì ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.</p>
        <form id="dataForm">
            <label for="phone">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="phone" name="Phone" required pattern="^0[689]\d{8}$" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å" />
            <button type="button" id="nextButton">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </form>
    </section>

    <section id="qr-section" class="hidden">
        <h1>‡πÅ‡∏™‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</h1>
        <div id="qr-reader"></div>
        <div id="responseMessage" style="font-weight: bold;"></div>
        
        <div class="progress-bar-container hidden" id="progressBarContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="progress-steps" class="message hidden"></div>
        <div id="comparison-details" class="hidden"></div>
        <button id="retryScanButton" class="hidden" style="margin-top: 20px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
    </section>

    <section id="success-section" class="hidden">
        <h1>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤</h1>
        <p class="message" id="successMessage"></p>
    </section>

    <div id="phoneConfirmModal" class="modal">
        <div class="modal-content">
            <h2>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <p>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: <strong id="phoneDisplay"></strong></p>
            <div class="modal-buttons">
                <button id="cancelPhoneButton">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmPhoneButton">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>
    
    <div id="scanSummaryModal" class="modal">
        <div class="modal-content">
            <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô</h2>
            <div id="summaryText" style="white-space: pre-wrap;"></div>
            <div class="modal-buttons">
                <button id="cancelScanButton">‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                <button id="confirmScanButton">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
    
    <div id="locationPermissionModal" class="modal">
      <div class="modal-content">
        <div id="permission-prompt">
            <h2>‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üìç</h2>
            <p>‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
            <p id="locationErrorText" style="color: #d32f2f; font-weight: bold; text-align: center;"></p>
            <div class="modal-buttons">
                <button id="showInstructionsButton">‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î</button>
                <button id="retryLocationButton">‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
        </div>
        
        <div id="locationInstructions" class="hidden">
            <h3 id="instructionsHeader"></h3>
            <p id="instructionsText" style="font-size: 15px;"></p>
            <button id="backToPermissionModal" type="button">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
        </div>
    </div>

    <script>
        // =================================================================
        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Cache ‡∏Ç‡∏≠‡∏á LIFF
        // =================================================================
        const originalFetch = window.fetch;
        window.fetch = async function(url, options) {
            if (url.toString().startsWith('https://liffsdk.line-scdn.net/') && url.toString().endsWith('.json')) {
                url = url + '?ts=' + Math.random();
            }
            return originalFetch(url, options);
        };
        // =================================================================

        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================
            // ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            // =================================================================
            const liffId = "2006142476-expQgry9"; // ‚ùó LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            const scriptURL = 'https://script.google.com/macros/s/AKfycby8iE0HQ4V_8rgjHNalxp1bM4VFxxz5JBXkUc0qpqkLxcYxM1iE5vmhQO0wCoNG1eIfCg/exec'; // ‚ùó URL ‡∏Ç‡∏≠‡∏á GAS
            // =================================================================
            let formData = {};
            let qrReaderInstance = null;
            let summaryMessageForLiff = '';

            const loadingMessage = document.getElementById('loading-message');
            const header = document.getElementById('header');
            const phoneModal = document.getElementById('phoneConfirmModal');
            const scanSummaryModal = document.getElementById('scanSummaryModal');
            const responseMessage = document.getElementById('responseMessage');
            const progressBarContainer = document.getElementById('progressBarContainer');
            const progressBar = document.getElementById('progressBar');
            
            const progressSteps = document.getElementById('progress-steps');
            const comparisonDetails = document.getElementById('comparison-details');
            const retryScanButton = document.getElementById('retryScanButton');
            
            // --- [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] Element ‡πÉ‡∏ô Modal ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ---
            const locationModal = document.getElementById('locationPermissionModal');
            const permissionPrompt = document.getElementById('permission-prompt');
            const locationErrorText = document.getElementById('locationErrorText');
            const showInstructionsButton = document.getElementById('showInstructionsButton');
            const locationInstructions = document.getElementById('locationInstructions');
            const instructionsHeader = document.getElementById('instructionsHeader');
            const instructionsText = document.getElementById('instructionsText');
            const backToPermissionModal = document.getElementById('backToPermissionModal');
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà ---

            async function main() {
                try {
                    await liff.init({ liffId });
                } catch (err) {
                    console.error("LIFF Initialization failed:", err);
                    loadingMessage.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF";
                    return;
                }

                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    loadingMessage.classList.add('hidden');
                    header.classList.remove('hidden');
                    showSection('form-section');
                }
            }
            
            async function getDeviceInfo() {
                let deviceUUID, displayName = "Unknown";
                try {
                    const profile = await liff.getProfile();
                    deviceUUID = profile.userId;
                    displayName = profile.displayName;
                } catch (e) {
                    deviceUUID = `no-liff-${crypto.randomUUID()}`;
                }
                return { uuid: deviceUUID, displayName: displayName };
            }

            function getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        return reject(new Error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"));
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            if (typeof position.coords.latitude === 'number' && typeof position.coords.longitude === 'number') {
                                resolve(position);
                            } else {
                                reject(new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ"));
                            }
                        },
                        (error) => {
                            let errorMessage;
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                    break;
                                default:
                                    errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                    break;
                            }
                            reject(new Error(errorMessage));
                        },
                        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                    );
                });
            }

            const showSection = (sectionId) => {
                document.querySelectorAll('section').forEach(section => {
                    section.classList.toggle('hidden', section.id !== sectionId);
                });
            };

            function callApi(action, params) {
                return new Promise((resolve, reject) => {
                    const callbackName = `jsonpCallback_${Date.now()}${Math.floor(Math.random() * 1000)}`;
                    window[callbackName] = (result) => {
                        delete window[callbackName];
                        document.body.removeChild(scriptElement);
                        resolve(result);
                    };
                    const url = new URL(scriptURL);
                    url.searchParams.append('action', action);
                    for (const key in params) {
                        url.searchParams.append(key, params[key]);
                    }
                    url.searchParams.append('callback', callbackName);
                    const scriptElement = document.createElement('script');
                    scriptElement.src = url.toString();
                    scriptElement.onerror = () => {
                        delete window[callbackName];
                        document.body.removeChild(scriptElement);
                        reject(new Error("API call failed. Check network or script URL."));
                    };
                    document.body.appendChild(scriptElement);
                });
            }

            async function handleQrScan(decodedText) {
                if (qrReaderInstance) {
                    await qrReaderInstance.stop().catch(err => console.error("Failed to stop scanner:", err));
                    qrReaderInstance = null;
                }
                if (!decodedText || !decodedText.trim()) {
                    responseMessage.innerText = 'QR code ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                    setTimeout(startQRScanner, 2500);
                    return;
                }
                formData.Secrete = decodedText.trim();
                const now = new Date();
                const thaiDate = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()}`;
                const thaiTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                summaryMessageForLiff = `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n--------------------\n‡∏Ñ‡∏∏‡∏ì: ${formData.Name}\n‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${formData.Phone}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate}\n‡πÄ‡∏ß‡∏•‡∏≤: ${thaiTime} ‡∏ô.`;
                document.getElementById('summaryText').innerText = summaryMessageForLiff;
                scanSummaryModal.style.display = 'flex';
                showSection('qr-section');
            }
            
            async function proceedWithSubmission() {
                scanSummaryModal.style.display = 'none';
                responseMessage.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...';
                
                progressBar.style.width = '0%';
                progressBarContainer.classList.remove('hidden');
                progressSteps.classList.remove('hidden');
                comparisonDetails.classList.add('hidden');
                retryScanButton.classList.add('hidden');

                try {
                    progressSteps.innerText = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1/3: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                    progressBar.style.width = '10%';
                    const addResult = await callApi('add', { text: JSON.stringify(formData) });
                    if (addResult.status !== 'added') throw addResult;
                    progressBar.style.width = '33%';
                    
                    progressSteps.innerText = `‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2/3: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...`;
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    progressBar.style.width = '66%';

                    progressSteps.innerText = '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3/3: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö...';
                    const checkParams = { 
                        name: addResult.nameForCheck, 
                        date: addResult.dateForCheck,
                        secrete: addResult.secreteForCheck
                    };
                    const checkResult = await callApi('check', checkParams);
                    progressBar.style.width = '100%';

                    if (checkResult.status === 'found') {
                        progressSteps.innerText = '‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!';
                        await showSuccessAndSendMessage();
                    } else {
                        throw checkResult;
                    }
                } catch (error) {
                    console.error('Process failed:', error);
                    progressBarContainer.classList.add('hidden');
                    progressSteps.classList.add('hidden');
                    responseMessage.innerText = '';

                    if (error.searchCriteria && error.foundData) {
                        displayComparison(error.searchCriteria, error.foundData);
                    } else {
                        comparisonDetails.innerHTML = `<div class="comparison-container"><h4>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h4><p style="text-align:center;">${error.message || '‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'}</p></div>`;
                        comparisonDetails.classList.remove('hidden');
                    }
                    retryScanButton.classList.remove('hidden');
                }
            }

            function displayComparison(sent, found) {
                let comparisonHTML = `
                    <div class="comparison-container">
                        <h4>‚ùå ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</h4>
                        <div class="comparison-grid">
                            <strong>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</strong> <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</strong>`;
                
                const fields = {'Name': '‡∏ä‡∏∑‡πà‡∏≠', 'Date': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Secrete': '‡∏£‡∏´‡∏±‡∏™ QR'};
                
                for (const key in fields) {
                    const label = fields[key];
                    const sentValue = sent[key.toLowerCase()];
                    const foundValue = found[key];
                    const isMismatch = sentValue !== foundValue;
                    
                    comparisonHTML += `
                        <strong>${label}</strong>
                        <span class="${isMismatch ? 'mismatch' : 'match'}">${foundValue || 'N/A'}</span>`;
                }

                comparisonHTML += '</div></div>';
                comparisonDetails.innerHTML = comparisonHTML;
                comparisonDetails.classList.remove('hidden');
            }
            
            async function showSuccessAndSendMessage() {
                showSection('success-section');
                document.getElementById('successMessage').innerText = `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...`;
                
                if (liff.isInClient()) {
                    try {
                        await liff.sendMessages([{ type: 'text', text: summaryMessageForLiff }]);
                        document.getElementById('successMessage').innerText = '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏ô 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ';
                        setTimeout(() => liff.closeWindow(), 1500);
                    } catch (err) {
                        document.getElementById('successMessage').innerText = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${err.message}`;
                    }
                } else {
                    document.getElementById('successMessage').innerText = `‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å LINE)\n\n${summaryMessageForLiff}`;
                }
            }

            async function startQRScanner() {
                responseMessage.innerHTML = '';
                progressBarContainer.classList.add('hidden');
                progressSteps.classList.add('hidden');
                comparisonDetails.classList.add('hidden');
                retryScanButton.classList.add('hidden');
                progressBar.style.width = '0%';
                showSection('qr-section');
                document.getElementById('qr-reader').innerHTML = '';

                if (liff.isInClient() && liff.isApiAvailable('scanCodeV2')) {
                    try {
                        const result = await liff.scanCodeV2();
                        if (result.value) await handleQrScan(result.value);
                    } catch (err) {
                        if (err.code === "USER_CANCEL") showSection('form-section');
                        else alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á LINE');
                    }
                } else {
                    responseMessage.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á...';
                    qrReaderInstance = new Html5Qrcode('qr-reader');
                    qrReaderInstance.start(
                        { facingMode: 'environment' }, { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => handleQrScan(decodedText), () => {}
                    ).catch(err => {
                        responseMessage.innerText = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á';
                    });
                }
            }

            // --- [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ---
            function showLocationInstructions() {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                permissionPrompt.classList.add('hidden');

                if (/android/i.test(userAgent)) {
                    instructionsHeader.innerText = '‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô Android';
                    instructionsText.innerHTML = `
                        1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings) > ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location)</b><br>
                        2. <b>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</b> ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á<br>
                        3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏õ <b>LINE</b> ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á<br>
                        4. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Å‡∏•‡∏±‡∏ö" ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
                    `;
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    instructionsHeader.innerText = '‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô iOS (iPhone/iPad)';
                    instructionsText.innerHTML = `
                        1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings) > ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Privacy & Security)</b><br>
                        2. ‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà <b>‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á (Location Services)</b> ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô<br>
                        3. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏´‡∏≤‡πÅ‡∏≠‡∏õ <b>LINE</b> ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ç‡∏ì‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏≠‡∏õ")<br>
                        4. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏Å‡∏•‡∏±‡∏ö" ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
                    `;
                } else {
                     instructionsHeader.innerText = '‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á';
                     instructionsText.innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏Å‡∏î "‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"';
                }
                locationInstructions.classList.remove('hidden');
            }

            async function attemptToGetLocationAndProceed() {
                phoneModal.style.display = 'none'; 
                loadingMessage.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á... üó∫Ô∏è</p>';
                loadingMessage.classList.remove('hidden');
                showSection('form-section'); 

                try {
                    const [deviceInfo, position] = await Promise.all([getDeviceInfo(), getCurrentLocation()]);
                    
                    formData = {
                        Phone: document.getElementById('phone').value.trim(),
                        UUID: deviceInfo.uuid,
                        Name: deviceInfo.displayName,
                        Latitude: position.coords.latitude,
                        Longitude: position.coords.longitude
                    };

                    loadingMessage.classList.add('hidden');
                    await startQRScanner();

                } catch (error) {
                    console.error("Location Error:", error.message);
                    loadingMessage.classList.add('hidden');
                    showSection('form-section'); 
                    
                    locationErrorText.innerText = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
                    locationModal.style.display = 'flex';
                }
            }
            
            document.getElementById('nextButton').addEventListener('click', () => {
                const phoneInput = document.getElementById('phone');
                if (!phoneInput.checkValidity()) {
                    alert(phoneInput.title);
                    return;
                }
                document.getElementById('phoneDisplay').innerText = phoneInput.value;
                phoneModal.style.display = 'flex';
            });
            
            document.getElementById('confirmPhoneButton').addEventListener('click', attemptToGetLocationAndProceed);
            
            document.getElementById('retryLocationButton').addEventListener('click', () => {
                locationModal.style.display = 'none';
                attemptToGetLocationAndProceed(); 
            });
            
            // --- [‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà] Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ---
            showInstructionsButton.addEventListener('click', showLocationInstructions);
            
            backToPermissionModal.addEventListener('click', () => {
                locationInstructions.classList.add('hidden');
                permissionPrompt.classList.remove('hidden');
            });
            // --- ‡∏à‡∏ö‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà ---

            document.getElementById('cancelPhoneButton').addEventListener('click', () => phoneModal.style.display = 'none');
            document.getElementById('confirmScanButton').addEventListener('click', proceedWithSubmission);
            document.getElementById('cancelScanButton').addEventListener('click', () => {
                scanSummaryModal.style.display = 'none';
                startQRScanner();
            });
            retryScanButton.addEventListener('click', startQRScanner);

            main();
        });
    </script>
</body>
</html>
